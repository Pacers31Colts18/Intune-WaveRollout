name: 02-assign-wave1

on:
  workflow_run:
    workflows: ["01-import-intune-policy"]
    types:
      - completed

permissions:
  id-token: write
  contents: read

jobs:
  wave1:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    environment: GraphApi

    steps:
      - uses: actions/checkout@v4

      - name: Get Changelog File from Previous Workflow
        id: get_changelog
        run: |
          # Use GitHub API to read workflow run outputs
          $workflowRunId = ${{ github.event.workflow_run.id }}
          $repo = "${{ github.repository }}"
          $token = "${{ secrets.GITHUB_TOKEN }}"

          $url = "https://api.github.com/repos/$repo/actions/runs/$workflowRunId/jobs"
          $jobs = Invoke-RestMethod -Uri $url -Headers @{Authorization = "Bearer $token"}

          # Find the job called 'import' and its outputs
          foreach ($job in $jobs.jobs) {
              if ($job.name -eq "import") {
                  # This gives you the changelog file path output
                  # We'll just reuse the name from Step 1 output
                  $changelog_file = "changelog/$($job.name)"  # Placeholder
              }
          }

          echo "changelog_file=$changelog_file" >> $env:GITHUB_ENV

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          allow-no-subscriptions: true

      - name: Assign Policies to Wave1
        shell: pwsh
        run: |
          $WAVE1_GROUP_ID = "${{ secrets.WAVE1_GROUP_ID }}"
          $filePath = "${{ env.changelog_file }}"

          if (!(Test-Path $filePath)) {
              Write-Host "Changelog file not found: $filePath"
              exit 1
          }

          $content = Get-Content $filePath
          $policyNames = $content | Where-Object { $_ -like "- *" } |
                         ForEach-Object { $_.Substring(2) }

          if (-not $policyNames) {
              Write-Host "No policies to assign."
              exit 0
          }

          $GraphTokenResponse = az account get-access-token --resource https://graph.microsoft.com
          $GraphToken = ($GraphTokenResponse | ConvertFrom-Json).accessToken
          $SecureToken = ConvertTo-SecureString $GraphToken -AsPlainText -Force
          Install-Module Microsoft.Graph.Authentication -Force -AllowClobber
          Install-Module Microsoft.Graph.Beta.DeviceManagement -Force -AllowClobber
          Connect-MgGraph -AccessToken $SecureToken

          foreach ($policyName in $policyNames) {

              $policy = Invoke-MgGraphRequest `
                -Method GET `
                -Uri "https://graph.microsoft.com/beta/deviceManagement/configurationPolicies?`$filter=name eq '$policyName'"

              if ($policy.value.Count -eq 0) { continue }

              $policyId = $policy.value[0].id
              Write-Host "Assigning $policyName to Wave1"

              $assignmentBody = @{
                assignments = @(
                  @{
                    target = @{
                      "@odata.type" = "#microsoft.graph.groupAssignmentTarget"
                      groupId = $WAVE1_GROUP_ID
                    }
                  }
                )
              }

              Invoke-MgGraphRequest `
                -Method POST `
                -Uri "https://graph.microsoft.com/beta/deviceManagement/configurationPolicies/$policyId/assign" `
                -Body ($assignmentBody | ConvertTo-Json -Depth 5)
          }
