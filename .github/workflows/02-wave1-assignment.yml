name: 02-wave1-assignment

on:
  workflow_run:
    workflows: ["01-import-intune"]
    types:
      - completed

permissions:
  id-token: write
  contents: read

env:
  DEV_GROUP_ID: ${{ secrets.WAVE1_GROUP_ID }}

jobs:
  assign-wave1:
    runs-on: ubuntu-latest
    environment: GraphApi

    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: changed-policies

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          allow-no-subscriptions: true

      - name: Assign Wave1 (Ring Aware)
        shell: pwsh
        run: |

          if (-not $env:DEV_GROUP_ID) {
              throw "DEV_GROUP_ID not set."
          }

          $GraphTokenResponse = az account get-access-token --resource https://graph.microsoft.com
          $GraphToken = ($GraphTokenResponse | ConvertFrom-Json).accessToken
          $SecureToken = ConvertTo-SecureString $GraphToken -AsPlainText -Force

          Install-Module Microsoft.Graph.Authentication -Force -AllowClobber
          Connect-MgGraph -AccessToken $SecureToken
          Select-MgProfile beta

          $policyNames = Get-Content ./changed-policies.txt

          foreach ($policyName in $policyNames) {

              Write-Host "Processing policy: $policyName"

              $policySearch = Invoke-MgGraphRequest `
                  -Method GET `
                  -Uri "https://graph.microsoft.com/beta/deviceManagement/configurationPolicies?`$filter=name eq '$policyName'"

              if (-not $policySearch.value) {
                  Write-Host "Policy not found. Skipping."
                  continue
              }

              $policy = $policySearch.value[0]

              $existingAssignments = Invoke-MgGraphRequest `
                  -Method GET `
                  -Uri "https://graph.microsoft.com/beta/deviceManagement/configurationPolicies/$($policy.id)/assignments"

              $assignmentArray = @()

              if ($existingAssignments.value) {
                  foreach ($assignment in $existingAssignments.value) {
                      $assignmentArray += @{
                          target = $assignment.target
                      }
                  }
              }

              $alreadyAssigned = $false

              foreach ($assignment in $existingAssignments.value) {
                  if ($assignment.target.groupId -eq $env:DEV_GROUP_ID) {
                      $alreadyAssigned = $true
                      break
                  }
              }

              if ($alreadyAssigned) {
                  Write-Host "Wave1 already assigned."
                  continue
              }

              $assignmentArray += @{
                  target = @{
                      "@odata.type" = "#microsoft.graph.groupAssignmentTarget"
                      groupId      = $env:DEV_GROUP_ID
                  }
              }

              $assignBody = @{
                  assignments = $assignmentArray
              }

              Invoke-MgGraphRequest `
                  -Method POST `
                  -Uri "https://graph.microsoft.com/beta/deviceManagement/configurationPolicies/$($policy.id)/assign" `
                  -Body ($assignBody | ConvertTo-Json -Depth 10)

              Write-Host "Wave1 assigned successfully."
          }
