name: Intune Policy Pipeline

on:
  pull_request:
    types: [labeled]

permissions:
  id-token: write
  contents: read
  pull-requests: write

env:
  REPO_DIR: ${{ github.workspace }}
  STAGING_FOLDER: ${{ github.workspace }}/staging
  CSV_PATH: ${{ github.workspace }}/staging/staging.csv

jobs:

  # ==========================================
  # IMPORT POLICIES
  # ==========================================
  import:
    if: github.event.label.name == 'import-policy'
    runs-on: ubuntu-latest
    environment: GraphApi

    steps:
      - uses: actions/checkout@v4

      - uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          allow-no-subscriptions: true

      - name: Install Graph Modules
        shell: pwsh
        run: |
          Install-Module Microsoft.Graph.Authentication -Force -AllowClobber
          Install-Module Microsoft.Graph.Beta.DeviceManagement -Force -AllowClobber

      - name: Import Policies
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          $token = (az account get-access-token --resource https://graph.microsoft.com | ConvertFrom-Json).accessToken
          Connect-MgGraph -AccessToken (ConvertTo-SecureString $token -AsPlainText -Force)

          Import-Module -Name "${{ env.REPO_DIR }}" -Force

          Import-IntuneSettingsCatalogPolicy -folderPath "${{ env.STAGING_FOLDER }}"

          Write-Host "Import complete."
  

  # ==========================================
  # PROMOTE WAVE 1
  # ==========================================
  promote_wave1:
    if: github.event.label.name == 'promote-wave1'
    runs-on: ubuntu-latest
    environment: Wave1

    steps:
      - uses: actions/checkout@v4
      - uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          allow-no-subscriptions: true

      - name: Assign Wave 1
        shell: pwsh
        run: |
          ./Scripts/Assign-IntunePolicies.ps1 -Wave Wave1


  # ==========================================
  # PROMOTE WAVE 2
  # ==========================================
  promote_wave2:
    if: github.event.label.name == 'promote-wave2'
    runs-on: ubuntu-latest
    environment: Wave2

    steps:
      - uses: actions/checkout@v4
      - uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          allow-no-subscriptions: true

      - name: Assign Wave 2
        shell: pwsh
        run: |
          ./Scripts/Assign-IntunePolicies.ps1 -Wave Wave2


  # ==========================================
  # PROMOTE WAVE 3
  # ==========================================
  promote_wave3:
    if: github.event.label.name == 'promote-wave3'
    runs-on: ubuntu-latest
    environment: Wave3

    steps:
      - uses: actions/checkout@v4
      - uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          allow-no-subscriptions: true

      - name: Assign Wave 3
        shell: pwsh
        run: |
          ./Scripts/Assign-IntunePolicies.ps1 -Wave Wave3


  # ==========================================
  # PRODUCTION
  # ==========================================
  production:
    if: github.event.label.name == 'production'
    runs-on: ubuntu-latest
    environment: Production

    steps:
      - uses: actions/checkout@v4
      - uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          allow-no-subscriptions: true

      - name: Assign Production
        shell: pwsh
        run: |
          ./Scripts/Assign-IntunePolicies.ps1 -Wave Production
