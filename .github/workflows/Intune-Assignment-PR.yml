name: GitHubAction-JL-Intune-AssignmentCheck-SettingsCatalog

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  pull-requests: write
  contents: read
  statuses: write
  id-token: write

env:
  REPO_DIR: ${{ github.workspace }}
  ASSIGNMENT_FOLDER: ${{ github.workspace }}/staging/assignments

jobs:
  validate_and_apply_assignments:
    runs-on: ubuntu-latest
    environment: GraphApi

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Login to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          allow-no-subscriptions: true

      - name: Install Microsoft Graph Modules
        shell: pwsh
        run: |
          Install-Module Microsoft.Graph.Authentication -Force -AllowClobber
          Install-Module Microsoft.Graph.Beta.DeviceManagement -Force -AllowClobber

      - name: Validate Assignment JSON
        id: validate
        shell: pwsh
        run: |
          $token = (az account get-access-token --resource https://graph.microsoft.com | ConvertFrom-Json).accessToken
          Connect-MgGraph -AccessToken (ConvertTo-SecureString $token -AsPlainText -Force)
          Import-Module -Name "${{ env.REPO_DIR }}" -Force
          
          # Ensure at least one JSON file exists
          $jsonFiles = Get-ChildItem -Path "${{ env.ASSIGNMENT_FOLDER }}" -Filter *.json
          if ($jsonFiles.Count -eq 0) {
              Write-Error "No assignment JSON files found in $($env:ASSIGNMENT_FOLDER)."
              exit 1
          }

          $assignmentsList = @()

          foreach ($file in $jsonFiles) {
              $json = Get-Content $file.FullName -Raw | ConvertFrom-Json

              if (-not $json.PolicyId) {
                  Write-Error "PolicyId is required in $($file.Name)."
                  exit 1
              }

              if (-not ($json.AssignmentMode -in @("Merge","Overwrite"))) {
                  Write-Error "AssignmentMode must be 'Merge' or 'Overwrite' in $($file.Name)."
                  exit 1
              }

              $uri = "https://graph.microsoft.com/beta/deviceManagement/configurationPolicies/$($json.PolicyId)"
              $policy = Invoke-MgGraphRequest -Uri $uri -Method GET

              if (-not $policy) {
                  Write-Error "PolicyId $($json.PolicyId) not found in tenant."
                  exit 1
              }

              Write-Host "Policy found: $($policy.DisplayName) [$($policy.Id)]"
              $assignmentsList += $json
          }

          echo "Assignments validated successfully."
          echo "validated_assignments=$(ConvertTo-Json $assignmentsList -Compress)" >> $GITHUB_OUTPUT
          
      - name: Capture Existing Assignments
        id: capture
        shell: pwsh
        run: |
          Import-Module -Name "${{ env.REPO_DIR }}" -Force
          $assignmentsList = '${{ steps.validate.outputs.validated_assignments }}' | ConvertFrom-Json
          $allAssignments = @()

          foreach ($item in $assignmentsList) {
              Write-Host "Fetching current assignments for PolicyId: $($item.PolicyId)"
              $current = Get-IntuneDeviceConfigurationPolicyAssignments -policyId $item.PolicyId

              if (-not $current -or $current.Count -eq 0) {
                  Write-Host "No existing assignments found for PolicyId: $($item.PolicyId)"
              }
              else {
                  Write-Host "Found $($current.Count) existing assignment(s) for PolicyId: $($item.PolicyId)"
              }

              $allAssignments += [PSCustomObject]@{
                  PolicyId          = $item.PolicyId
                  CurrentAssignments = $current
                  NewAssignments     = $item.Assignments
                  Mode               = $item.AssignmentMode
              }
          }

          echo "all_assignments=$(ConvertTo-Json $allAssignments -Depth 10 -Compress)" >> $GITHUB_OUTPUT

      - name: Apply Assignments
        shell: pwsh
        run: |
          Import-Module -Name "${{ env.REPO_DIR }}" -Force
          $allAssignments = '${{ steps.capture.outputs.all_assignments }}' | ConvertFrom-Json

          foreach ($assignment in $allAssignments) {
              Write-Host "Applying assignments for PolicyId: $($assignment.PolicyId) with mode: $($assignment.Mode)"

              if ($assignment.Mode -eq "Overwrite") {
                  # Remove existing assignments first
                  Write-Host "Overwriting existing assignments..."
                  Set-IntuneDeviceConfigurationPolicyAssignments -PolicyId $assignment.PolicyId -Assignments @() -Mode Overwrite
              }

              # Merge new assignments
              foreach ($a in $assignment.NewAssignments) {
                  Write-Host "Assigning Group: $($a.GroupName), Type: $($a.AssignmentType), Filter: $($a.FilterName), FilterMode: $($a.FilterMode)"
                  Set-IntuneDeviceConfigurationPolicyAssignments -PolicyId $assignment.PolicyId -Assignments @($a) -Mode Merge
              }
          }

          Write-Host "All assignments applied successfully."

      - name: Set PR Status
        shell: pwsh
        run: |
          $SHA = "${GITHUB_SHA}"
          gh api repos/${{ github.repository }}/statuses/$SHA \
            -f state=success \
            -f context="Assignment-Gate" \
            -f description="Assignment validation and application completed successfully."
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
