name: GitHubAction-JL-Intune-AssignmentCheck-SettingsCatalog

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  pull-requests: write
  contents: read
  statuses: write
  id-token: write

env:
  REPO_DIR: ${{ github.workspace }}
  ASSIGNMENT_FOLDER: ${{ github.workspace }}/staging/assignments
  ARTIFACT_NAME: artifacts
  EXPORT_FOLDER: ${{ github.workspace }}/staging/assignments/artifacts
  MERGED_FILE: ${{ github.workspace }}/staging/assignments/merged-assignments.json

jobs:
  validate_and_apply_assignments:
    runs-on: ubuntu-latest
    environment: GraphApi

    steps:
      # -------------------------------
      # Checkout & Login
      # -------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Login to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          allow-no-subscriptions: true

      - name: Install Microsoft Graph Modules
        shell: pwsh
        run: |
          Install-Module Microsoft.Graph.Authentication -Force -AllowClobber
          Install-Module Microsoft.Graph.Beta.DeviceManagement -Force -AllowClobber

      # -------------------------------
      # Step 1: Capture Existing Assignments
      # -------------------------------
      - name: Capture Existing Assignments
        id: capture
        shell: pwsh
        run: |
          $token = (az account get-access-token --resource https://graph.microsoft.com | ConvertFrom-Json).accessToken
          Connect-MgGraph -AccessToken (ConvertTo-SecureString $token -AsPlainText -Force)
          Import-Module -Name "${{ env.REPO_DIR }}" -Force

          $jsonFiles = Get-ChildItem -Path "${{ env.ASSIGNMENT_FOLDER }}" -Filter *.json
          if ($jsonFiles.Count -eq 0) {
              Write-Warning "No assignment JSON files found in $($env:ASSIGNMENT_FOLDER)"
              exit 0
          }

          if (-not (Test-Path "${{ env.EXPORT_FOLDER }}")) {
              New-Item -Path "${{ env.EXPORT_FOLDER }}" -ItemType Directory -Force | Out-Null
          }

          $allAssignments = @()

          foreach ($file in $jsonFiles) {
              $json = Get-Content $file.FullName -Raw | ConvertFrom-Json
              
              # Get unique PolicyId
              $policyId = @($json.value | Select-Object -ExpandProperty sourceId -Unique)[0]
              
              Write-Host "Fetching current assignments for PolicyId: $policyId"
          
              # Export assignments to JSON
              $currentJson = Export-IntuneDeviceConfigurationPolicyAssignments -policyId $policyId -outputFolder "${{ env.EXPORT_FOLDER }}"
          
              $allAssignments += [PSCustomObject]@{
                  PolicyId    = $policyId
                  Assignments = ($currentJson | ConvertFrom-Json -Depth 10)
              }
          }

          # Step output for downstream use
          echo "all_assignments=$(ConvertTo-Json $allAssignments -Depth 10 -Compress)" >> $env:GITHUB_OUTPUT

      # -------------------------------
      # Step 2: Upload artifact of existing assignments
      # -------------------------------
      - name: Upload existing assignments artifact
        if: ${{ steps.capture.outputs.all_assignments != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: ${{ env.EXPORT_FOLDER }}

      # -------------------------------
      # Step 3: Create new assignments based off CSV
      # -------------------------------    
      - name: Create New Assignments Based off CSV
        id: create_new_json
        shell: pwsh
        run: |
          $token = (az account get-access-token --resource https://graph.microsoft.com | ConvertFrom-Json).accessToken
          Connect-MgGraph -AccessToken (ConvertTo-SecureString $token -AsPlainText -Force)
          Import-Module -Name "${{ env.REPO_DIR }}" -Force

          # Get CSV Files
          $newFiles = Get-ChildItem -Path "${{ env.ASSIGNMENT_FOLDER }}" -Filter *.csv
          $csvFile = Import-CSV $newFiles

          if ($csvFile.Count -eq 0) {
              Write-Error "No new assignment CSV files found."
              exit 1
              }
              
              foreach ($file in $csvFile) {
              Write-Host "Creating new assignment JSON from CSV"
              New-IntuneAssignmentJson -inputfilePath $file -outputfilePath "${{ env.EXPORT_FOLDER }}\new_$($csvfile.policyId).json"

              echo "new_assignments_path=${{ env.EXPORT_FOLDER }}" >> $env:GITHUB_OUTPUT
          
      # -------------------------------
      # Step 3: Validate and Merge Assignments (all Merge)
      # -------------------------------
      - name: Validate and Merge Assignments
        id: validate
        shell: pwsh
        run: |
          $token = (az account get-access-token --resource https://graph.microsoft.com | ConvertFrom-Json).accessToken
          Connect-MgGraph -AccessToken (ConvertTo-SecureString $token -AsPlainText -Force)
          Import-Module -Name "${{ env.REPO_DIR }}" -Force
          
            # Get existing exported JSON files    
            $existingFiles = Get-ChildItem -Path "${{ env.EXPORT_FOLDER }}" -Filter *.json
        
              # Get new JSON files
              $newFiles = Get-ChildItem -Path "${{ env.ASSIGNMENT_FOLDER }}" -Filter *.json
              
              if ($newFiles.Count -eq 0) {
                  Write-Error "No new assignment JSON files found."
                  exit 1
              }
              
              foreach ($newFile in $newFiles) {
          
              # Extract PolicyId from new file
              $newJson = Get-Content $newFile.FullName -Raw | ConvertFrom-Json
              $policyId = @($newJson.value | Select-Object -ExpandProperty sourceId -Unique)[0]
          
              # Find matching existing file
              $existingFile = $existingFiles | Where-Object {
                  (Get-Content $_.FullName -Raw | ConvertFrom-Json).value.sourceId -contains $policyId
              }
          
              $outputFile = "${{ env.MERGED_FILE }}"
          
              if ($existingFile) {
                  Write-Host "Merging existing and new assignments for PolicyId $policyId"
                  Merge-IntuneAssignmentJson -originalassignmentFile $existingFile.FullName -additionalassignmentFile $newFile.FullName -OutputFile $outputFile
              }
              else {
                  Write-Host "No existing assignments found for PolicyId $policyId. Using new file only."
                  }
          }
          
          echo "merged_assignments_path=${{ env.MERGED_FILE }}" >> $env:GITHUB_OUTPUT

      # -------------------------------
      # Step 4: Apply assignments
      # -------------------------------
      - name: Apply Assignments
        shell: pwsh
        run: |
          $token = (az account get-access-token --resource https://graph.microsoft.com | ConvertFrom-Json).accessToken
          Connect-MgGraph -AccessToken (ConvertTo-SecureString $token -AsPlainText -Force)
          Import-Module -Name "${{ env.REPO_DIR }}" -Force
      
          # Detect the JSON file in the folder (assuming only one exists)
          $assignmentFiles = Get-ChildItem -Path "${{ env.ASSIGNMENT_FOLDER }}" -Filter *.json
      
          if ($assignmentFiles.Count -eq 0) {
              Write-Error "No assignment JSON files found in $($env:ASSIGNMENT_FOLDER)"
              exit 1
          }
          elseif ($assignmentFiles.Count -gt 1) {
              Write-Warning "More than one JSON file found. Using the first one: $($assignmentFiles[0].FullName)"
          }
      
          $assignmentFile = $assignmentFiles[0].FullName
          Write-Host "Applying assignments from $assignmentFile"
      
          # Apply the assignments
          Set-IntuneDeviceConfigurationPolicyAssignment -InputFilePath $assignmentFile
          Write-Host "All assignments applied successfully."

      # -------------------------------
      # Step 5: Set PR Status
      # -------------------------------
      - name: Set PR Status
        shell: pwsh
        run: |
          $SHA = "${GITHUB_SHA}"
          gh api repos/${{ github.repository }}/statuses/$SHA `
            -f state=success `
            -f context="Assignment-Gate" `
            -f description="Assignment validation and application completed successfully."
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
