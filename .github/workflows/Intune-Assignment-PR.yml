name: GitHubAction-JL-Intune-AssignmentCheck-SettingsCatalog

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  pull-requests: write
  contents: read
  statuses: write
  id-token: write

env:
  REPO_DIR: ${{ github.workspace }}
  ASSIGNMENT_FOLDER: ${{ github.workspace }}/staging/assignments
  ARTIFACT_NAME: artifacts
  EXPORT_FOLDER: ${{ github.workspace }}/staging/assignments/artifacts
  MERGED_FILE: ${{ github.workspace }}/staging/assignments/merged-assignments.json

jobs:
  validate_and_apply_assignments:
    runs-on: ubuntu-latest
    environment: GraphApi

    steps:
      # -------------------------------
      # Checkout & Login
      # -------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Login to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          allow-no-subscriptions: true

      - name: Install Microsoft Graph Modules
        shell: pwsh
        run: |
          Install-Module Microsoft.Graph.Authentication -Force -AllowClobber
          Install-Module Microsoft.Graph.Beta.DeviceManagement -Force -AllowClobber

      # -------------------------------
      # Step 1: Capture Existing Assignments
      # -------------------------------
      - name: Capture Existing Assignments
        id: capture_existing_json
        shell: pwsh
        run: |
          $token = (az account get-access-token --resource https://graph.microsoft.com | ConvertFrom-Json).accessToken
          Connect-MgGraph -AccessToken (ConvertTo-SecureString $token -AsPlainText -Force)
          Import-Module -Name "${{ env.REPO_DIR }}" -Force

          # Get CSV Files for PolicyIds
          $csvFiles = Get-ChildItem -Path "${{ env.ASSIGNMENT_FOLDER }}" -Filter *.csv
          if ($csvFiles.Count -eq 0) {
              Write-Error "No CSV files found in $($env:ASSIGNMENT_FOLDER)"
              exit 1
          }

          if (-not (Test-Path "${{ env.EXPORT_FOLDER }}")) {
              New-Item -Path "${{ env.EXPORT_FOLDER }}" -ItemType Directory -Force | Out-Null
          }

          $allAssignments = @()

          # Initialize a set to track processed PolicyIds
          $processedPolicyIds = @{}

          # Loop over CSV files
          foreach ($file in $csvFiles) {
              $csvData = Import-Csv -Path $file.FullName

              # Loop over each row in the CSV
              foreach ($row in $csvData) {
                  $policyId = $row.PolicyId
                  if (-not $policyId) {
                      Write-Warning "PolicyId is missing in the row, skipping..."
                      continue
                  }

                  # Check if this PolicyId has already been processed
                  if ($processedPolicyIds.Contains($policyId)) {
                      Write-Host "PolicyId $policyId has already been processed, skipping..."
                      continue
                  }

                  # Mark the PolicyId as processed
                  $processedPolicyIds[$policyId] = $true

                  Write-Host "Fetching current assignments for PolicyId: $policyId"

                  # Export assignments to JSON based on PolicyId
                  $currentJson = Export-IntuneDeviceConfigurationPolicyAssignments -policyId $policyId -outputFolder "${{ env.EXPORT_FOLDER }}"

                  # Store assignments for this PolicyId
                  $allAssignments += [PSCustomObject]@{
                      PolicyId    = $policyId
                      Assignments = ($currentJson | ConvertFrom-Json -Depth 10)
                  }
              }
          }

          # Store the file path for later use
          $existingFile = (Get-ChildItem -Path "${{ env.EXPORT_FOLDER }}" -Filter "*_Assignments.json").FullName
          echo "existing_assignments_path=$existingFile" >> $env:GITHUB_OUTPUT

      # -------------------------------
      # Step 2: Upload artifact of existing assignments
      # -------------------------------
      - name: Upload existing assignments artifact
        if: ${{ steps.capture_existing_json.outputs.existing_assignments_path != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: existing-assignments
          path: ${{ env.EXPORT_FOLDER }}

      # -------------------------------
      # Step 3: Create new assignments based off CSV
      # -------------------------------    
      - name: Create New Assignments Based off CSV
        id: create_new_json
        shell: pwsh
        run: |
          $token = (az account get-access-token --resource https://graph.microsoft.com | ConvertFrom-Json).accessToken
          Connect-MgGraph -AccessToken (ConvertTo-SecureString $token -AsPlainText -Force)
          Import-Module -Name "${{ env.REPO_DIR }}" -Force

          # Get CSV Files
          $newFiles = Get-ChildItem -Path "${{ env.ASSIGNMENT_FOLDER }}" -Filter *.csv
          if ($newFiles.Count -eq 0) {
              Write-Error "No new assignment CSV files found."
              exit 1
          }

          foreach ($file in $newFiles) {
              Write-Host "Creating new assignment JSON from CSV: $($file.Name)"

              # Pass file path to the function
              New-IntuneAssignmentJson -InputFilePath $file.FullName -OutputFilePath "${{ env.EXPORT_FOLDER }}\$($file.BaseName).json"
          }

          # Store the file path for later use
          $newAssignmentFile = (Get-ChildItem -Path "${{ env.EXPORT_FOLDER }}" -Filter "*_Assignments.json").FullName
          echo "new_assignments_path=$newAssignmentFile" >> $env:GITHUB_OUTPUT

      # -------------------------------
      # Step 4: Upload new assignments artifact
      # -------------------------------    
      - name: Upload new assignments artifact
        if: ${{ steps.create_new_json.outputs.new_assignments_path != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: new-assignments
          path: ${{ env.EXPORT_FOLDER }}

      # -------------------------------
      # Step 5: Validate and Merge Assignments (all Merge)
      # -------------------------------
      - name: Validate and Merge Assignments
        id: validate
        shell: pwsh
        run: |
          $token = (az account get-access-token --resource https://graph.microsoft.com | ConvertFrom-Json).accessToken
          Connect-MgGraph -AccessToken (ConvertTo-SecureString $token -AsPlainText -Force)
          Import-Module -Name "${{ env.REPO_DIR }}" -Force
      
          # Retrieve the paths of existing and new assignment files
          $existingFilePath = '${{ steps.capture.outputs.existing_assignments_path }}'
          $newFilePath = '${{ steps.create_new_json.outputs.new_assignments_path }}'
      
          # Get the actual JSON files from the directories
          $existingFile = Get-ChildItem -Path $existingFilePath -Filter *.json | Select-Object -First 1
          $newFile = Get-ChildItem -Path $newFilePath -Filter *.json | Select-Object -First 1
      
          Write-Host "Existing Assignment File: $($existingFile.FullName)"
          Write-Host "New Assignment File: $($newFile.FullName)"
      
          # Validate that the paths point to valid files
          if (-not (Test-Path $existingFile.FullName)) {
              Write-Error "Existing assignment JSON file not found at $($existingFile.FullName)"
              exit 1
          }
      
          if (-not (Test-Path $newFile.FullName)) {
              Write-Error "New assignment JSON file not found at $($newFile.FullName)"
              exit 1
          }
      
          # Merging the files
          Write-Host "Merging existing and new assignments for PolicyId"
          Merge-IntuneAssignmentJson -originalassignmentFile $existingFile.FullName -additionalassignmentFile $newFile.FullName -OutputFile "${{ env.MERGED_FILE }}"
      
          # Output the path of merged file for next steps
          echo "merged_assignments_path=${{ env.MERGED_FILE }}" >> $env:GITHUB_OUTPUT

      # -------------------------------
      # Step 6: Upload merged assignments artifact
      # -------------------------------
      - name: Upload merged assignments artifact
        if: ${{ steps.validate.outputs.merged_assignments_path != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: merged-assignments
          path: ${{ env.MERGED_FILE }}

      # -------------------------------
      # Step 7: Apply assignments
      # -------------------------------
      - name: Apply Assignments
        shell: pwsh
        run: |
          $token = (az account get-access-token --resource https://graph.microsoft.com | ConvertFrom-Json).accessToken
          Connect-MgGraph -AccessToken (ConvertTo-SecureString $token -AsPlainText -Force)
          Import-Module -Name "${{ env.REPO_DIR }}" -Force

          # Use the merged assignments path directly
          $assignmentFile = "${{ env.MERGED_FILE }}"

          if (-not (Test-Path $assignmentFile)) {
              Write-Error "Merged assignment JSON file not found at $assignmentFile"
              exit 1
          }

          Write-Host "Applying assignments from $assignmentFile"

          # Apply the assignments from the merged file
          Set-IntuneDeviceConfigurationPolicyAssignment -InputFilePath $assignmentFile
          Write-Host "All assignments applied successfully."
