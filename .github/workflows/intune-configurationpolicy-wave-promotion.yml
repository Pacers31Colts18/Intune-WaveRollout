name: Intune Configuration Policy Lifecycle

on:
  workflow_dispatch:
  pull_request:
    types: [opened, synchronize]

permissions:
  id-token: write
  contents: write
  pull-requests: write

env:
  REPO_DIR: ${{ github.workspace }}

jobs:

  # -------------------------
  # Import Policies
  # -------------------------
  import:
    runs-on: ubuntu-latest
    environment: Import
    outputs:
      policy_ids: ${{ steps.save_ids.outputs.policy_ids }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          allow-no-subscriptions: true

      - name: Import Policies
        id: save_ids
        shell: pwsh
        run: |
          $stagingPath = "${{ github.workspace }}/staging.csv"
          if (-not (Test-Path $stagingPath)) { Write-Host "No staging.csv found"; exit 0 }

          $staging = Import-Csv $stagingPath
          $uniquePolicies = $staging.FileName | Sort-Object -Unique
          $policyIds = @{}

          # Get Graph token
          $tokenResp = az account get-access-token --resource https://graph.microsoft.com
          $graphToken = ($tokenResp | ConvertFrom-Json).accessToken
          $secureToken = ConvertTo-SecureString $graphToken -AsPlainText -Force

          Install-Module Microsoft.Graph.Authentication -Force -AllowClobber
          Install-Module Microsoft.Graph.Beta.DeviceManagement -Force -AllowClobber
          Connect-MgGraph -AccessToken $secureToken

          foreach ($file in $uniquePolicies) {
              $policyName = $file.Replace(".json","")

              $jsonPath = "${{ github.workspace }}/policies/$file"
              if (Test-Path $jsonPath) {
                  $json = Get-Content $jsonPath -Raw | ConvertFrom-Json
                  $json.PSObject.Properties.Remove('id')
                  $json.PSObject.Properties.Remove('createdDateTime')
                  $json.PSObject.Properties.Remove('lastModifiedDateTime')
                  $json.PSObject.Properties.Remove('version')
                  $json.PSObject.Properties.Remove('supportedScopeTags')
              } else {
                  $json = @{ name = $policyName; "@odata.type"="#microsoft.graph.deviceConfiguration" }
              }

              # Check if exists
              $existingRaw = Invoke-MgGraphRequest -Method GET `
                -Uri "https://graph.microsoft.com/beta/deviceManagement/configurationPolicies?`$filter=name eq '$policyName'"
              $existing = $existingRaw | ConvertFrom-Json

              if ($existing.value.Count -gt 0) {
                  $policyId = $existing.value[0].id
                  Invoke-MgGraphRequest -Method PATCH `
                    -Uri "https://graph.microsoft.com/beta/deviceManagement/configurationPolicies/$policyId" `
                    -Body ($json | ConvertTo-Json -Depth 100)
              } else {
                  $createdRaw = Invoke-MgGraphRequest -Method POST `
                    -Uri "https://graph.microsoft.com/beta/deviceManagement/configurationPolicies" `
                    -Body ($json | ConvertTo-Json -Depth 100)
                  $created = $createdRaw | ConvertFrom-Json
                  $policyId = $created.id
              }

              $policyIds[$file] = $policyId
              Write-Host "Imported '$policyName' -> $policyId"
          }

          # Expose JSON mapping for downstream steps
          $jsonOutput = $policyIds | ConvertTo-Json -Compress
          echo "policy_ids=$jsonOutput" >> $GITHUB_OUTPUT

  # -------------------------
  # Assignment Step
  # -------------------------
  assign:
    needs: import
    runs-on: ubuntu-latest
    environment: GraphApi
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          allow-no-subscriptions: true

      - name: Assign Policies
        shell: pwsh
        run: |
          $policyIds = ${{ fromJson(needs.import.outputs.policy_ids) }}
          $stagingPath = "${{ github.workspace }}/staging.csv"
          $staging = Import-Csv $stagingPath

          $tokenResp = az account get-access-token --resource https://graph.microsoft.com
          $graphToken = ($tokenResp | ConvertFrom-Json).accessToken
          $secureToken = ConvertTo-SecureString $graphToken -AsPlainText -Force

          Install-Module Microsoft.Graph.Authentication -Force -AllowClobber
          Install-Module Microsoft.Graph.Beta.DeviceManagement -Force -AllowClobber
          Connect-MgGraph -AccessToken $secureToken

          foreach ($row in $staging) {
              $file = $row.FileName
              $policyId = $policyIds[$file]
              if (-not $policyId) { Write-Host "Skipping $file, no policy ID"; continue }

              # Build assignment body
              $assignments = @()
              if ($row.IncludeGroups) {
                  $includeGroups = $row.IncludeGroups -split ';'
                  foreach ($g in $includeGroups) {
                      $assignments += @{
                          target = @{
                              "@odata.type" = "#microsoft.graph.groupAssignmentTarget"
                              groupId = $g
                          }
                      }
                  }
              }

              if ($row.Filter -and $row.FilterMode -eq 'Include' -and $row.IncludeGroups) {
                  $filterName = $row.Filter
                  # Find filter ID by name
                  $filterRaw = Invoke-MgGraphRequest -Method GET `
                      -Uri "https://graph.microsoft.com/beta/deviceManagement/assignmentFilters?`$filter=displayName eq '$filterName'"
                  $filterObj = $filterRaw | ConvertFrom-Json
                  if ($filterObj.value.Count -gt 0) {
                      $filterId = $filterObj.value[0].id
                      foreach ($a in $assignments) {
                          $a.target.assignmentFilterId = $filterId
                          $a.target.assignmentFilterType = "include"
                      }
                  }
              }

              # Decide if targeting All Devices / All Users
              $isAllDevices = ($row.IncludeGroups -eq 'All Devices' -or $row.IncludeGroups -eq 'All Users')
              if ($isAllDevices) {
                  # Clear assignments except for this target
                  $assignments = @($assignments[0])
              }

              if ($assignments.Count -eq 0) { Write-Host "No assignments for $file"; continue }

              $body = @{ assignments = $assignments }
              Invoke-MgGraphRequest -Method POST `
                  -Uri "https://graph.microsoft.com/beta/deviceManagement/configurationPolicies/$policyId/assign" `
                  -Body ($body | ConvertTo-Json -Depth 10)

              Write-Host "Assigned $file -> $($row.IncludeGroups)"
