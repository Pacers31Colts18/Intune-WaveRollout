name: Intune Scheduled Policy Deployment

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

permissions:
  id-token: write
  contents: write
  pull-requests: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: GraphApi

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          allow-no-subscriptions: true

      - name: Process Deployment Queue
        id: process
        shell: pwsh
        run: |

          $repoRoot = $env:GITHUB_WORKSPACE
          $stagingPath = Join-Path $repoRoot "staging.csv"
          $historyPath = Join-Path $repoRoot "deployment-history.csv"

          if (-not (Test-Path $stagingPath)) {
              Write-Host "No staging.csv found."
              exit 0
          }

          $today = (Get-Date).ToString("yyyy-MM-dd")

          Install-Module Microsoft.Graph.Authentication -Force -AllowClobber
          Install-Module Microsoft.Graph.Beta.DeviceManagement -Force -AllowClobber

          $GraphTokenResponse = az account get-access-token --resource https://graph.microsoft.com
          $GraphToken = ($GraphTokenResponse | ConvertFrom-Json).accessToken
          $SecureToken = ConvertTo-SecureString $GraphToken -AsPlainText -Force
          Connect-MgGraph -AccessToken $SecureToken

          $staging = Import-Csv $stagingPath
          $due = $staging | Where-Object { $_.DeploymentDate -le $today }

          if (-not $due) {
              Write-Host "No deployments due."
              exit 0
          }

          $remaining = @()
          $historyEntries = @()

          foreach ($item in $staging) {

              if ($item.DeploymentDate -le $today) {

                  $filePath = Join-Path $repoRoot "policies/$($item.FileName)"

                  if (-not (Test-Path $filePath)) {
                      Write-Host "Missing policy file $($item.FileName)"
                      continue
                  }

                  $json = Get-Content $filePath -Raw | ConvertFrom-Json
                  $policyName = $json.name

                  $existing = Invoke-MgGraphRequest `
                    -Method GET `
                    -Uri "https://graph.microsoft.com/beta/deviceManagement/configurationPolicies?`$filter=name eq '$policyName'"

                  if ($existing.value.Count -eq 0) {
                      $created = Invoke-MgGraphRequest `
                        -Method POST `
                        -Uri "https://graph.microsoft.com/beta/deviceManagement/configurationPolicies" `
                        -Body ($json | ConvertTo-Json -Depth 100)
                      $policyId = $created.id
                  }
                  else {
                      $policyId = $existing.value[0].id
                  }

                  $group = Invoke-MgGraphRequest `
                    -Method GET `
                    -Uri "https://graph.microsoft.com/v1.0/groups?`$filter=displayName eq '$($item.GroupName)'"

                  if ($group.value.Count -eq 0) {
                      Write-Host "Group not found $($item.GroupName)"
                      continue
                  }

                  $groupId = $group.value[0].id

                  $assignments = Invoke-MgGraphRequest `
                    -Method GET `
                    -Uri "https://graph.microsoft.com/beta/deviceManagement/configurationPolicies/$policyId/assignments"

                  $alreadyAssigned = $assignments.value |
                      Where-Object { $_.target.groupId -eq $groupId }

                  if (-not $alreadyAssigned) {

                      $assignmentBody = @{
                        assignments = @(
                          @{
                            target = @{
                              "@odata.type" = "#microsoft.graph.groupAssignmentTarget"
                              groupId = $groupId
                            }
                          }
                        )
                      }

                      Invoke-MgGraphRequest `
                        -Method POST `
                        -Uri "https://graph.microsoft.com/beta/deviceManagement/configurationPolicies/$policyId/assign" `
                        -Body ($assignmentBody | ConvertTo-Json -Depth 10)

                      Write-Host "Assigned $policyName to $($item.GroupName)"
                  }

                  $historyEntries += [PSCustomObject]@{
                      FileName       = $item.FileName
                      GroupName      = $item.GroupName
                      DeploymentDate = $item.DeploymentDate
                      ProcessedDate  = $today
                  }

              }
              else {
                  $remaining += $item
              }
          }

          # Write remaining queue
          $remaining | Export-Csv $stagingPath -NoTypeInformation

          # Append history
          if (Test-Path $historyPath) {
              $existingHistory = Import-Csv $historyPath
              $historyEntries = $existingHistory + $historyEntries
          }

          $historyEntries | Export-Csv $historyPath -NoTypeInformation

          echo "changes=true" >> $env:GITHUB_OUTPUT

      - name: Create PR for Queue Update
        if: steps.process.outputs.changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          branch: deployment-cleanup-${{ github.run_number }}
          commit-message: "Remove processed deployments"
          title: "Deployment Queue Cleanup"
          body: "Automated removal of processed deployment rows."
