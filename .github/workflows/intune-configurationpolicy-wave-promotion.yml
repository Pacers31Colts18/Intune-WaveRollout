name: Intune Wave Deployment

on:
  workflow_dispatch: {}
  schedule:
    - cron: "0 * * * *"  # every hour to check rollout.yml

permissions:
  id-token: write
  contents: read
  pull-requests: write

jobs:

  import-policies:
    runs-on: ubuntu-latest
    environment: Import
    steps:
      - uses: actions/checkout@v4
      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          allow-no-subscriptions: true

      - name: Install YAML Module
        shell: pwsh
        run: |
          Install-Module powershell-yaml -Force -AllowClobber
          Import-Module powershell-yaml

      - name: Import policies from PR
        shell: pwsh
        run: |
          $rolloutPath = "${{ github.workspace }}/rollout.yml"
          $rollout = Get-Content $rolloutPath -Raw | ConvertFrom-Yaml

          foreach ($policy in $rollout.policies) {
              $jsonPath = "${{ github.workspace }}/policies/$($policy.file)"
              $json = Get-Content $jsonPath -Raw | ConvertFrom-Json
              # Import logic here (PATCH or POST) ...
          }

  deploy-wave:
    needs: import-policies
    runs-on: ubuntu-latest
    environment: GraphApi
    steps:
      - uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          allow-no-subscriptions: true

      - name: Install YAML Module
        shell: pwsh
        run: |
          Install-Module powershell-yaml -Force -AllowClobber
          Import-Module powershell-yaml

      - name: Deploy eligible waves
        shell: pwsh
        run: |
          $rolloutPath = "${{ github.workspace }}/rollout.yml"
          $rollout = Get-Content $rolloutPath -Raw | ConvertFrom-Yaml
          $now = Get-Date -AsUTC

          foreach ($policy in $rollout.policies) {
              $deployTime = [datetime]::Parse($policy.deployTime)
              if ($deployTime -le $now) {
                  Write-Host "Deploying $($policy.file) to $($policy.wave)"

                  # Load policy JSON
                  $jsonPath = "${{ github.workspace }}/policies/$($policy.file)"
                  $json = Get-Content $jsonPath -Raw | ConvertFrom-Json

                  # Determine assignment targets
                  # Accumulate previous assignments except for All Users/All Devices
                  # Apply include/exclude groups as per YAML
                  # Call Microsoft Graph PATCH/POST as needed
              } else {
                  Write-Host "Skipping $($policy.file) (scheduled for $deployTime)"
              }
          }
