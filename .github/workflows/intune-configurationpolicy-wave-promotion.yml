name: Intune Wave Deployment

on:
  workflow_dispatch: {}
  schedule:
    - cron: "0 * * * *"  # every hour to check rollout.yml

permissions:
  id-token: write
  contents: read
  pull-requests: write

jobs:

  import-policies:
    runs-on: ubuntu-latest
    environment: Import
    steps:
      - uses: actions/checkout@v4
      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          allow-no-subscriptions: true

      - name: Install YAML Module
        shell: pwsh
        run: |
          Install-Module powershell-yaml -Force -AllowClobber
          Import-Module powershell-yaml
      - name: Import policies from PR
        shell: pwsh
        run: |
          # Path to rollout YAML in PR
          $rolloutPath = "${{ github.workspace }}/rollout.yml"
      
          # Load YAML module
          Install-Module powershell-yaml -Force -AllowClobber
          Import-Module powershell-yaml
      
          # Parse rollout file
          $rollout = Get-Content $rolloutPath -Raw | ConvertFrom-Yaml
      
          # Get Azure Graph token
          $GraphTokenResponse = az account get-access-token --resource https://graph.microsoft.com
          $GraphToken = ($GraphTokenResponse | ConvertFrom-Json).accessToken
          $SecureToken = ConvertTo-SecureString $GraphToken -AsPlainText -Force
          Install-Module Microsoft.Graph.Authentication -Force -AllowClobber
          Install-Module Microsoft.Graph.Beta.DeviceManagement -Force -AllowClobber
          Connect-MgGraph -AccessToken $SecureToken
      
          # Import each policy
          foreach ($policy in $rollout.policies) {
              $jsonPath = "${{ github.workspace }}/policies/$($policy.file)"
              if (-Not (Test-Path $jsonPath)) {
                  Write-Host "Policy file $jsonPath not found, skipping."
                  continue
              }
      
              $json = Get-Content $jsonPath -Raw | ConvertFrom-Json
              $policyName = $json.name
      
              # Check if policy exists
              $existing = Invoke-MgGraphRequest `
                  -Method GET `
                  -Uri "https://graph.microsoft.com/beta/deviceManagement/configurationPolicies?`$filter=name eq '$policyName'"
      
              if ($existing.value.Count -gt 0) {
                  $policyId = $existing.value[0].id
                  Write-Host "Updating existing policy $policyName"
                  Invoke-MgGraphRequest `
                      -Method PATCH `
                      -Uri "https://graph.microsoft.com/beta/deviceManagement/configurationPolicies/$policyId" `
                      -Body ($json | ConvertTo-Json -Depth 100)
              } else {
                  Write-Host "Creating new policy $policyName"
                  $created = Invoke-MgGraphRequest `
                      -Method POST `
                      -Uri "https://graph.microsoft.com/beta/deviceManagement/configurationPolicies" `
                      -Body ($json | ConvertTo-Json -Depth 100)
                  $policyId = $created.id
              }
      
              # Remove all assignments so waves can start fresh
              $assignments = Invoke-MgGraphRequest `
                  -Method GET `
                  -Uri "https://graph.microsoft.com/beta/deviceManagement/configurationPolicies/$policyId/assignments"
              foreach ($a in $assignments.value) {
                  Invoke-MgGraphRequest `
                      -Method DELETE `
                      -Uri "https://graph.microsoft.com/beta/deviceManagement/configurationPolicies/$policyId/assignments/$($a.id)"
              }
      
              Write-Host "Policy '$policyName' imported successfully with no assignments."
          }

  deploy-wave:
    needs: import-policies
    runs-on: ubuntu-latest
    environment: GraphApi
    steps:
      - uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          allow-no-subscriptions: true

      - name: Install YAML Module
        shell: pwsh
        run: |
          Install-Module powershell-yaml -Force -AllowClobber
          Import-Module powershell-yaml

      - name: Deploy eligible waves
        shell: pwsh
        run: |
          $rolloutPath = "${{ github.workspace }}/rollout.yml"
          $rollout = Get-Content $rolloutPath -Raw | ConvertFrom-Yaml
          $now = Get-Date -AsUTC

          foreach ($policy in $rollout.policies) {
              $deployTime = [datetime]::Parse($policy.deployTime)
              if ($deployTime -le $now) {
                  Write-Host "Deploying $($policy.file) to $($policy.wave)"

                  # Load policy JSON
                  $jsonPath = "${{ github.workspace }}/policies/$($policy.file)"
                  $json = Get-Content $jsonPath -Raw | ConvertFrom-Json

                  # Determine assignment targets
                  # Accumulate previous assignments except for All Users/All Devices
                  # Apply include/exclude groups as per YAML
                  # Call Microsoft Graph PATCH/POST as needed
              } else {
                  Write-Host "Skipping $($policy.file) (scheduled for $deployTime)"
              }
          }
