name: Intune Configuration Policy Lifecycle

on:
  pull_request:
    types: [opened, synchronize, reopened] # Trigger import on PR creation or update
  workflow_dispatch: # Manual trigger for assignments
  schedule:
    - cron: '0 3 * * *' # Optional: cron trigger (UTC)

permissions:
  id-token: write
  contents: write
  pull-requests: write

env:
  REPO_DIR: ${{ github.workspace }}

jobs:

  # -------------------------
  # Import Policies (PR Trigger)
  # -------------------------
  import:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    environment: Import
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          allow-no-subscriptions: true

      - name: Import policies from PR
        shell: pwsh
        run: |
          $stagingPath = "${{ github.workspace }}/staging.csv"
          if (-not (Test-Path $stagingPath)) { Write-Host "No staging.csv found"; exit 0 }

          $staging = Import-Csv $stagingPath

          # Azure Graph login
          $tokenResp = az account get-access-token --resource https://graph.microsoft.com
          $graphToken = ($tokenResp | ConvertFrom-Json).accessToken
          $secureToken = ConvertTo-SecureString $graphToken -AsPlainText -Force
          Install-Module Microsoft.Graph.Authentication -Force -AllowClobber
          Install-Module Microsoft.Graph.Beta.DeviceManagement -Force -AllowClobber
          Connect-MgGraph -AccessToken $secureToken

          foreach ($deploy in $staging) {
              $jsonPath = "${{ github.workspace }}/policies/$($deploy.FileName)"
              if (-not (Test-Path $jsonPath)) { Write-Host "Skipping $($deploy.FileName)"; continue }

              $json = Get-Content $jsonPath -Raw | ConvertFrom-Json
              $policyName = $json.name

              $existing = Invoke-MgGraphRequest -Method GET -Uri "https://graph.microsoft.com/beta/deviceManagement/configurationPolicies?`$filter=name eq '$policyName'"
              if ($existing.value.Count -gt 0) {
                  $policyId = $existing.value[0].id
                  Write-Host "Updating policy: $policyName"
                  Invoke-MgGraphRequest -Method PATCH -Uri "https://graph.microsoft.com/beta/deviceManagement/configurationPolicies/$policyId" -Body ($json | ConvertTo-Json -Depth 100)
              } else {
                  Write-Host "Creating policy: $policyName"
                  $created = Invoke-MgGraphRequest -Method POST -Uri "https://graph.microsoft.com/beta/deviceManagement/configurationPolicies" -Body ($json | ConvertTo-Json -Depth 100)
                  $policyId = $created.id
              }

              Write-Host "Policy '$policyName' imported successfully. No assignments applied."
          }

  # -------------------------
  # Assignment Step (Manual / Cron)
  # -------------------------
  assign-policies:
    needs: import
    runs-on: ubuntu-latest
    environment: GraphApi
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          allow-no-subscriptions: true

      - name: Apply assignments from staging.csv
        shell: pwsh
        run: |
          $stagingPath = "${{ github.workspace }}/staging.csv"
          if (-not (Test-Path $stagingPath)) { Write-Host "No staging.csv found"; exit 0 }

          $staging = Import-Csv $stagingPath

          # Azure Graph login
          $tokenResp = az account get-access-token --resource https://graph.microsoft.com
          $graphToken = ($tokenResp | ConvertFrom-Json).accessToken
          $secureToken = ConvertTo-SecureString $graphToken -AsPlainText -Force
          Install-Module Microsoft.Graph.Authentication -Force -AllowClobber
          Install-Module Microsoft.Graph.Beta.DeviceManagement -Force -AllowClobber
          Connect-MgGraph -AccessToken $secureToken

          foreach ($deploy in $staging) {
              $jsonPath = "${{ github.workspace }}/policies/$($deploy.FileName)"
              if (-not (Test-Path $jsonPath)) { Write-Host "Skipping $($deploy.FileName)"; continue }

              $json = Get-Content $jsonPath -Raw | ConvertFrom-Json
              $policyName = $json.name

              # Get policy
              $existing = Invoke-MgGraphRequest -Method GET -Uri "https://graph.microsoft.com/beta/deviceManagement/configurationPolicies?`$filter=name eq '$policyName'"
              if ($existing.value.Count -eq 0) {
                  Write-Host "Policy '$policyName' must be imported first!"
                  continue
              }
              $policyId = $existing.value[0].id

              # Lookup Filter ID if provided
              $filterId = $null
              if ($deploy.Filter) {
                  $filterResp = Invoke-MgGraphRequest -Method GET -Uri "https://graph.microsoft.com/beta/deviceManagement/assignmentFilters?`$filter=displayName eq '$($deploy.Filter)'"
                  if ($filterResp.value.Count -gt 0) {
                      $filterId = $filterResp.value[0].id
                  } else {
                      Write-Host "Filter '$($deploy.Filter)' not found. Skipping filter for '$policyName'"
                  }
              }

              # Handle IncludeGroups
              $includeGroups = @()
              if ($deploy.IncludeGroups) {
                  $newGroups = $deploy.IncludeGroups -split ','
                  if ($newGroups -contains "AllUsers" -or $newGroups -contains "AllDevices") {
                      # Overwrite previous include assignments
                      $assignments = Invoke-MgGraphRequest -Method GET -Uri "https://graph.microsoft.com/beta/deviceManagement/configurationPolicies/$policyId/assignments"
                      foreach ($a in $assignments.value) {
                          Invoke-MgGraphRequest -Method DELETE -Uri "https://graph.microsoft.com/beta/deviceManagement/configurationPolicies/$policyId/assignments/$($a.id)"
                      }
                      $includeGroups = $newGroups
                  } else {
                      # Accumulate
                      $existingAssign = Invoke-MgGraphRequest -Method GET -Uri "https://graph.microsoft.com/beta/deviceManagement/configurationPolicies/$policyId/assignments"
                      $existingGroups = $existingAssign.value | ForEach-Object { $_.target.groupId }
                      $includeGroups = $existingGroups + $newGroups
                  }
              }

              # Apply IncludeGroups
              foreach ($g in $includeGroups) {
                  $assignment = @{
                      target = @{
                          "@odata.type" = "#microsoft.graph.groupAssignmentTarget"
                          groupId = $g
                      }
                  }
                  if ($filterId -and $deploy.FilterMode -eq "Include") {
                      $assignment["deviceAndAppManagementAssignmentFilterId"] = $filterId
                      $assignment["deviceAndAppManagementAssignmentFilterType"] = "include"
                  } elseif ($filterId -and $deploy.FilterMode -eq "Exclude") {
                      $assignment["deviceAndAppManagementAssignmentFilterId"] = $filterId
                      $assignment["deviceAndAppManagementAssignmentFilterType"] = "exclude"
                  }

                  $body = @{ assignments = @($assignment) }
                  Invoke-MgGraphRequest -Method POST -Uri "https://graph.microsoft.com/beta/deviceManagement/configurationPolicies/$policyId/assign" -Body ($body | ConvertTo-Json -Depth 10)
              }

              # Apply ExcludeGroups
              if ($deploy.ExcludeGroups) {
                  $excludeGroups = $deploy.ExcludeGroups -split ','
                  foreach ($g in $excludeGroups) {
                      $body = @{
                          assignments = @(@{
                              target = @{
                                  "@odata.type" = "#microsoft.graph.groupAssignmentTarget"
                                  groupId = $g
                              }
                          })
                      }
                      Invoke-MgGraphRequest -Method POST -Uri "https://graph.microsoft.com/beta/deviceManagement/configurationPolicies/$policyId/assign" -Body ($body | ConvertTo-Json -Depth 10)
                  }
              }

              Write-Host "Policy '$policyName' assigned. IncludeGroups: $($includeGroups -join ',') ExcludeGroups: $($deploy.ExcludeGroups) Filter: $($deploy.Filter) Mode: $($deploy.FilterMode)"
          }
