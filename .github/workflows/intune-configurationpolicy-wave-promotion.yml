name: Intune Configuration Policy Lifecycle

on:
  workflow_dispatch:      # Manual trigger
  pull_request:
    types: [opened, synchronize]

permissions:
  id-token: write
  contents: write
  pull-requests: write

env:
  REPO_DIR: ${{ github.workspace }}

jobs:

  # -------------------------
  # Import Policies
  # -------------------------
  import:
    runs-on: ubuntu-latest
    environment: Import
    outputs:
      imported_file: ${{ steps.save_ids.outputs.imported_file }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          allow-no-subscriptions: true

      - name: Import policies from PR
        id: save_ids
        shell: pwsh
        run: |
          $stagingPath = "${{ github.workspace }}/staging.csv"
          if (-not (Test-Path $stagingPath)) { Write-Host "No staging.csv found"; exit 0 }

          $staging = Import-Csv $stagingPath
          $uniquePolicies = $staging.FileName | Sort-Object -Unique

          $importedPolicies = @{}

          $tokenResp = az account get-access-token --resource https://graph.microsoft.com
          $graphToken = ($tokenResp | ConvertFrom-Json).accessToken
          $secureToken = ConvertTo-SecureString $graphToken -AsPlainText -Force

          Install-Module Microsoft.Graph.Authentication -Force -AllowClobber
          Install-Module Microsoft.Graph.Beta.DeviceManagement -Force -AllowClobber
          Connect-MgGraph -AccessToken $secureToken

          foreach ($file in $uniquePolicies) {
              $jsonPath = "${{ github.workspace }}/policies/$file"
              if (-not (Test-Path $jsonPath)) { Write-Host "Skipping $file"; continue }

              $json = Get-Content $jsonPath -Raw | ConvertFrom-Json
              $policyName = $json.name

              $existing = Invoke-MgGraphRequest -Method GET -Uri "https://graph.microsoft.com/beta/deviceManagement/configurationPolicies?`$filter=name eq '$policyName'"
              if ($existing.value.Count -gt 0) {
                  $policyId = $existing.value[0].id
                  Invoke-MgGraphRequest -Method PATCH -Uri "https://graph.microsoft.com/beta/deviceManagement/configurationPolicies/$policyId" -Body ($json | ConvertTo-Json -Depth 100)
              } else {
                  $created = Invoke-MgGraphRequest -Method POST -Uri "https://graph.microsoft.com/beta/deviceManagement/configurationPolicies" -Body ($json | ConvertTo-Json -Depth 100)
                  $policyId = $created.id
              }

              $importedPolicies[$file] = $policyId
              Write-Host "Policy '$policyName' imported successfully with ID $policyId."
          }

          $importedFile = "${{ github.workspace }}/imported-policies.json"
          $importedPolicies | ConvertTo-Json | Out-File -FilePath $importedFile -Encoding UTF8
          echo "imported_file=$importedFile" >> $GITHUB_OUTPUT

  # -------------------------
  # Apply Assignments
  # -------------------------
  assign:
    needs: import
    runs-on: ubuntu-latest
    environment: Wave1
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          allow-no-subscriptions: true

      - name: Apply Assignments
        shell: pwsh
        run: |
          $stagingPath = "${{ github.workspace }}/staging.csv"
          $idFile = "${{ needs.import.outputs.imported_file }}"

          if (-not (Test-Path $stagingPath)) { Write-Host "No staging.csv found"; exit 0 }
          if (-not (Test-Path $idFile)) { Write-Host "No imported-policies.json found"; exit 1 }

          $policyIds = Get-Content $idFile -Raw | ConvertFrom-Json
          $staging = Import-Csv $stagingPath

          $tokenResp = az account get-access-token --resource https://graph.microsoft.com
          $graphToken = ($tokenResp | ConvertFrom-Json).accessToken
          $secureToken = ConvertTo-SecureString $graphToken -AsPlainText -Force

          Install-Module Microsoft.Graph.Authentication -Force -AllowClobber
          Install-Module Microsoft.Graph.Beta.DeviceManagement -Force -AllowClobber
          Connect-MgGraph -AccessToken $secureToken

          foreach ($deploy in $staging) {
              $file = $deploy.FileName
              if (-not $policyIds.ContainsKey($file)) {
                  Write-Host "Policy $file not imported; skipping assignment"
                  continue
              }

              $policyId = $policyIds[$file]

              # Determine filter if provided
              $filterId = $null
              if ($deploy.Filter) {
                  $filterResp = Invoke-MgGraphRequest -Method GET -Uri "https://graph.microsoft.com/beta/deviceManagement/assignmentFilters?`$filter=displayName eq '$($deploy.Filter)'"
                  if ($filterResp.value.Count -gt 0) { $filterId = $filterResp.value[0].id }
                  else { Write-Host "Filter '$($deploy.Filter)' not found, skipping filter for $file" }
              }

              $targetGroupId = $deploy.GroupId
              $mode = $deploy.FilterMode  # Include / Exclude

              # Fetch existing assignments
              $existing = Invoke-MgGraphRequest -Method GET -Uri "https://graph.microsoft.com/beta/deviceManagement/configurationPolicies/$policyId/assignments"

              $bodyAssignments = @()

              if ($targetGroupId -eq "AllUsers" -or $targetGroupId -eq "AllDevices") {
                  # Replace assignments
                  $bodyAssignments += @{
                      target = @{
                          "@odata.type" = "#microsoft.graph.groupAssignmentTarget"
                          groupId = $targetGroupId
                      }
                      filterId = $filterId
                      filterMode = $mode
                  }
              } else {
                  # Accumulate assignments
                  $bodyAssignments = $existing.value | ForEach-Object {
                      @{
                        target = $_.target
                        filterId = $_.filterId
                        filterMode = $_.filterMode
                      }
                  }
                  $bodyAssignments += @{
                      target = @{
                          "@odata.type" = "#microsoft.graph.groupAssignmentTarget"
                          groupId = $targetGroupId
                      }
                      filterId = $filterId
                      filterMode = $mode
                  }
              }

              $assignBody = @{ assignments = $bodyAssignments }
              Invoke-MgGraphRequest -Method POST -Uri "https://graph.microsoft.com/beta/deviceManagement/configurationPolicies/$policyId/assign" -Body ($assignBody | ConvertTo-Json -Depth 10)
              Write-Host "Policy $file assigned to $targetGroupId (Filter: $($deploy.Filter), Mode: $mode)"
          }
