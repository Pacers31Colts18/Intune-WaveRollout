name: Intune Configuration Policy Lifecycle

on:
  pull_request:
    types: [opened, synchronize]
    branches:
      - main
  workflow_dispatch:

permissions:
  id-token: write
  contents: write
  pull-requests: write

env:
  REPO_DIR: ${{ github.workspace }}

jobs:

  # -------------------------
  # Import Policies
  # -------------------------
  import:
    runs-on: ubuntu-latest
    environment: Import
    outputs:
      policy_ids_file: ${{ steps.set_ids.outputs.policy_ids_file }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          allow-no-subscriptions: true

      - name: Import Policies from CSV
        id: set_ids
        shell: pwsh
        run: |
          $csvPath = "${{ github.workspace }}/staging.csv"
          if (-not (Test-Path $csvPath)) {
              Write-Host "staging.csv not found!"
              exit 1
          }

          $rows = Import-Csv -Path $csvPath

          Install-Module Microsoft.Graph.Authentication -Force -AllowClobber
          Install-Module Microsoft.Graph.Beta.DeviceManagement -Force -AllowClobber

          $tokenResponse = az account get-access-token --resource https://graph.microsoft.com
          $token = ($tokenResponse | ConvertFrom-Json).accessToken
          $secureToken = ConvertTo-SecureString $token -AsPlainText -Force
          Connect-MgGraph -AccessToken $secureToken

          $policyIds = @()
          foreach ($row in $rows) {
              $jsonPath = "${{ github.workspace }}/policies/$($row.FileName)"
              if (-not (Test-Path $jsonPath)) {
                  Write-Host "Skipping $($row.FileName): file not found"
                  continue
              }

              $json = Get-Content $jsonPath -Raw | ConvertFrom-Json

              # Remove readonly/extraneous properties
              $json.PSObject.Properties.Remove('id')
              $json.PSObject.Properties.Remove('createdDateTime')
              $json.PSObject.Properties.Remove('lastModifiedDateTime')
              $json.PSObject.Properties.Remove('version')
              $json.PSObject.Properties.Remove('supportedScopeTags')

              # Check if policy exists
              try {
                  $existingRaw = Invoke-MgGraphRequest -Method GET -Uri "https://graph.microsoft.com/beta/deviceManagement/configurationPolicies?`$filter=name eq '$($json.name)'"
                  $existing = $existingRaw | ConvertFrom-Json
              } catch {
                  $existing = $null
              }

              if ($existing -and $existing.value.Count -gt 0) {
                  $policyId = $existing.value[0].id
                  Invoke-MgGraphRequest -Method PATCH `
                    -Uri "https://graph.microsoft.com/beta/deviceManagement/configurationPolicies/$policyId" `
                    -Body ($json | ConvertTo-Json -Depth 10)
                  Write-Host "Updated policy $($json.name)"
              } else {
                  $createdRaw = Invoke-MgGraphRequest -Method POST `
                    -Uri "https://graph.microsoft.com/beta/deviceManagement/configurationPolicies" `
                    -Body ($json | ConvertTo-Json -Depth 10)
                  try {
                      $created = $createdRaw | ConvertFrom-Json
                      $policyId = $created.id
                  } catch {
                      # fallback: parse as hashtable
                      $policyId = $createdRaw.id
                  }
                  Write-Host "Created policy $($json.name)"
              }

              $policyIds += @{ FileName = $row.FileName; Id = $policyId }
          }

          # Save mapping to JSON for downstream jobs
          $policyIdsFile = "${{ github.workspace }}/policy-ids.json"
          $policyIds | ConvertTo-Json -Depth 10 | Out-File -FilePath $policyIdsFile -Encoding UTF8
          echo "policy_ids_file=$policyIdsFile" >> $GITHUB_OUTPUT

  # -------------------------
  # Assign Policies (manual trigger)
  # -------------------------
  assign:
    needs: import
    runs-on: ubuntu-latest
    environment: WaveAssignment
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          allow-no-subscriptions: true

      - name: Assign Policies from CSV
        shell: pwsh
        run: |
          $csvPath = "${{ github.workspace }}/staging.csv"
          $policyIdsFile = "${{ needs.import.outputs.policy_ids_file }}"

          if (-not (Test-Path $csvPath)) { throw "staging.csv missing" }
          if (-not (Test-Path $policyIdsFile)) { throw "policy-ids.json missing" }

          $rows = Import-Csv -Path $csvPath
          $policyIds = Get-Content $policyIdsFile | ConvertFrom-Json

          Install-Module Microsoft.Graph.Authentication -Force -AllowClobber
          Install-Module Microsoft.Graph.Beta.DeviceManagement -Force -AllowClobber

          $tokenResponse = az account get-access-token --resource https://graph.microsoft.com
          $token = ($tokenResponse | ConvertFrom-Json).accessToken
          $secureToken = ConvertTo-SecureString $token -AsPlainText -Force
          Connect-MgGraph -AccessToken $secureToken

          foreach ($row in $rows) {
              $policyEntry = $policyIds | Where-Object { $_.FileName -eq $row.FileName }
              if (-not $policyEntry) { continue }

              $policyId = $policyEntry.Id

              # Determine include/exclude
              $includeGroups = @()
              if ($row.IncludeGroups) { $includeGroups = $row.IncludeGroups -split ';' }
              $excludeGroups = @()
              if ($row.ExcludeGroups) { $excludeGroups = $row.ExcludeGroups -split ';' }

              # Lookup FilterId if FilterName provided
              $filterId = $null
              if ($row.Filter) {
                  $filterResp = Invoke-MgGraphRequest -Method GET `
                      -Uri "https://graph.microsoft.com/beta/deviceManagement/assignmentFilters?`$filter=displayName eq '$($row.Filter)'"
                  $filterObj = $filterResp | ConvertFrom-Json
                  if ($filterObj.value.Count -gt 0) { $filterId = $filterObj.value[0].id }
              }

              # Assign Include Groups
              foreach ($g in $includeGroups) {
                  $body = @{
                      target = @{
                          "@odata.type" = "#microsoft.graph.groupAssignmentTarget"
                          groupId = $g
                      }
                  }
                  if ($filterId) { $body.filterId = $filterId }
                  Invoke-MgGraphRequest -Method POST `
                    -Uri "https://graph.microsoft.com/beta/deviceManagement/configurationPolicies/$policyId/assignments" `
                    -Body ($body | ConvertTo-Json -Depth 10)
                  Write-Host "Assigned $($row.FileName) to Include group $g"
              }

              # Assign Exclude Groups
              foreach ($g in $excludeGroups) {
                  $body = @{
                      target = @{
                          "@odata.type" = "#microsoft.graph.exclusionGroupAssignmentTarget"
                          groupId = $g
                      }
                  }
                  Invoke-MgGraphRequest -Method POST `
                    -Uri "https://graph.microsoft.com/beta/deviceManagement/configurationPolicies/$policyId/assignments" `
                    -Body ($body | ConvertTo-Json -Depth 10)
                  Write-Host "Assigned $($row.FileName) to Exclude group $g"
              }
