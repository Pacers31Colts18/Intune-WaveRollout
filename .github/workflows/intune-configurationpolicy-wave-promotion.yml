name: Intune Scheduled Policy Deployment

on:
  schedule:
    - cron: '0 2 * * *'   # Daily 2AM UTC
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: Prod

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          allow-no-subscriptions: true

      - name: Process Staging File
        shell: pwsh
        run: |

          Write-Host "Starting scheduled Intune deployment..."

          $today = (Get-Date).ToString("yyyy-MM-dd")
          Write-Host "Today: $today"

          if (-not (Test-Path "staging.csv")) {
              Write-Host "No staging.csv found."
              exit 0
          }

          Install-Module Microsoft.Graph.Authentication -Force -AllowClobber
          Install-Module Microsoft.Graph.Beta.DeviceManagement -Force -AllowClobber

          $GraphTokenResponse = az account get-access-token --resource https://graph.microsoft.com
          $GraphToken = ($GraphTokenResponse | ConvertFrom-Json).accessToken
          $SecureToken = ConvertTo-SecureString $GraphToken -AsPlainText -Force
          Connect-MgGraph -AccessToken $SecureToken

          $staging = Import-Csv "staging.csv"

          $dueItems = $staging | Where-Object {
              $_.DeploymentDate -le $today
          }

          if (-not $dueItems) {
              Write-Host "No deployments scheduled for today."
              exit 0
          }

          foreach ($item in $dueItems) {

              $filePath = "policies/$($item.FileName)"

              if (-not (Test-Path $filePath)) {
                  Write-Host "Policy file missing: $filePath"
                  continue
              }

              $json = Get-Content $filePath -Raw | ConvertFrom-Json
              $policyName = $json.name

              Write-Host "Processing policy: $policyName"
              Write-Host "Target group: $($item.GroupName)"

              # Check if policy exists
              $existing = Invoke-MgGraphRequest `
                -Method GET `
                -Uri "https://graph.microsoft.com/beta/deviceManagement/configurationPolicies?`$filter=name eq '$policyName'"

              if ($existing.value.Count -eq 0) {
                  Write-Host "Policy not found. Creating..."
                  $created = Invoke-MgGraphRequest `
                    -Method POST `
                    -Uri "https://graph.microsoft.com/beta/deviceManagement/configurationPolicies" `
                    -Body ($json | ConvertTo-Json -Depth 100)
                  $policyId = $created.id
              }
              else {
                  $policyId = $existing.value[0].id
                  Write-Host "Policy already exists."
              }

              # Get group by name dynamically
              $group = Invoke-MgGraphRequest `
                -Method GET `
                -Uri "https://graph.microsoft.com/v1.0/groups?`$filter=displayName eq '$($item.GroupName)'"

              if ($group.value.Count -eq 0) {
                  Write-Host "Group not found: $($item.GroupName)"
                  continue
              }

              $groupId = $group.value[0].id

              # Check existing assignments
              $assignments = Invoke-MgGraphRequest `
                -Method GET `
                -Uri "https://graph.microsoft.com/beta/deviceManagement/configurationPolicies/$policyId/assignments"

              $alreadyAssigned = $false
              foreach ($a in $assignments.value) {
                  if ($a.target.groupId -eq $groupId) {
                      $alreadyAssigned = $true
                  }
              }

              if ($alreadyAssigned) {
                  Write-Host "Already assigned to $($item.GroupName). Skipping."
                  continue
              }

              # Assign (accumulative)
              $assignmentBody = @{
                assignments = @(
                  @{
                    target = @{
                      "@odata.type" = "#microsoft.graph.groupAssignmentTarget"
                      groupId = $groupId
                    }
                  }
                )
              }

              Invoke-MgGraphRequest `
                -Method POST `
                -Uri "https://graph.microsoft.com/beta/deviceManagement/configurationPolicies/$policyId/assign" `
                -Body ($assignmentBody | ConvertTo-Json -Depth 10)

              Write-Host "Successfully assigned to $($item.GroupName)"
          }

          Write-Host "Deployment cycle completed."
